<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Dashboard - Axxess Sales</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #007ACC; --success: #28A745; --bg: #F8F9FA; --text: #212529; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); }
        .sidebar { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); height: 100vh; padding: 2rem; }
        .progress { height: 1.5rem; background: #e9ecef; }
        .card { box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .btn-primary { background: var(--primary); border: none; }
        .btn-primary:hover { background: #0056B3; }
        .alert { margin: 1rem 0; }
    </style>
    <script type="module" src="supabase-config.js"></script>
</head>
<body>
    <div class="d-flex">
        <nav class="sidebar col-md-3 col-lg-2 d-md-block bg-light">
            <div class="position-sticky pt-3">
                <h4>Welcome, <span id="agentName"></span>!</h4>
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#progress">Progress</a></li>
                    <li class="nav-item"><a class="nav-link" href="#log-sale">Log Sale</a></li>
                    <li class="nav-item"><a class="nav-link" href="#messages">Messages</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html">Logout</a></li>
                </ul>
            </div>
        </nav>
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3">
                <h1 class="h2">Sales Dashboard</h1>
            </div>
            <!-- Progress Section -->
            <section id="progress" class="card mb-4">
                <div class="card-header"><h5>Your Progress</h5></div>
                <div class="card-body">
                    <p><strong>Monthly Target:</strong> <span id="target">R0</span> (Set by management—per Axxess guidelines, no edits here)</p>
                    <p><strong>Current Sales:</strong> <span id="currentSales">R0</span></p>
                    <div class="progress mb-3">
                        <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p id="progressText">0% to target</p>
                    <small class="text-muted">T&Cs: Sales logged compliantly—no decreases allowed.</small>
                </div>
            </section>
            <!-- Log Sale Section -->
            <section id="log-sale" class="card mb-4">
                <div class="card-header"><h5>Log a Sale</h5></div>
                <div class="card-body">
                    <form id="saleForm">
                        <div class="mb-3">
                            <label class="form-label">Package Type</label>
                            <select class="form-select" id="packageType" required>
                                <option value="">Select...</option>
                                <option value="Fibre Uncapped 50Mbps|R599|Uncapped, 1TB fair use before depri">Fibre Uncapped 50Mbps - R599 (Uncapped, 1TB fair use)</option>
                                <option value="LTE Uncapped 10Mbps|R299|Uncapped, POPIA consent req.">LTE Uncapped 10Mbps - R299 (Uncapped, POPIA consent req.)</option>
                                <option value="5G Home Starter|R379|Uncapped, nationwide coverage">5G Home Starter - R379 (Uncapped, nationwide)</option>
                                <option value="VoIP Activation|R99|No monthly fee, free Axxess calls">VoIP Activation - R99 (No monthly, free Axxess calls)</option>
                                <option value="Hosting Basic|R49|SSD storage, unlimited domains">Hosting Basic - R49 (SSD, unlimited domains)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Amount (R)</label>
                            <input type="number" class="form-control" id="amount" step="0.01" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Log Sale</button>
                    </form>
                    <div id="saleAlert" class="alert d-none" role="alert"></div>
                </div>
            </section>
            <!-- Messages Section -->
            <section id="messages" class="card">
                <div class="card-header"><h5>Messages from Management</h5></div>
                <div class="card-body">
                    <div id="messagesList"></div>
                </div>
            </section>
        </main>
    </div>
    <script type="module">
        import { supabase } from './supabase-config.js';
        const userId = localStorage.getItem('userId');
        if (!userId) window.location.href = 'index.html';  // Redirect if not logged in
        let agentData = {};

        // Load Agent Data & Progress
        async function loadAgent() {
            const { data: agent } = await supabase.from('agents').select('*').eq('id', userId).single();
            if (!agent) return alert('Agent not found');
            agentData = agent;
            document.getElementById('agentName').textContent = agent.name;
            document.getElementById('target').textContent = `R${agent.target.toLocaleString()}`;
            document.getElementById('currentSales').textContent = `R${agent.sales.toLocaleString()}`;
            const percentage = agent.target > 0 ? (agent.sales / agent.target * 100) : 0;
            document.getElementById('progressBar').style.width = `${Math.min(percentage, 100)}%`;
            document.getElementById('progressText').textContent = `${percentage.toFixed(1)}% to target`;
        }

        // Package Amount Auto-Fill
        document.getElementById('packageType').addEventListener('change', (e) => {
            const [name, amountStr] = e.target.value.split('|');
            document.getElementById('amount').value = amountStr ? amountStr.replace('R', '') : '';
        });

        // Log Sale Form
        document.getElementById('saleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const packageType = document.getElementById('packageType').value.split('|')[0];
            const amount = parseFloat(document.getElementById('amount').value);
            if (!packageType || !amount) return;
            const { error: logError } = await supabase.from('sales_log').insert({
                agent_id: userId,
                package_type: packageType,
                amount
            });
            if (logError) return showAlert(logError.message, 'danger');
            // Update agent sales (trigger enforces no decrease)
            const newSales = agentData.sales + amount;
            const { error: updateError } = await supabase.from('agents').update({ sales: newSales }).eq('id', userId);
            if (updateError) return showAlert(updateError.message, 'danger');
            showAlert(`Sale logged: ${packageType} for R${amount}! Total now R${newSales.toLocaleString()}.`, 'success');
            loadAgent();  // Refresh progress
            e.target.reset();
        });

        // Load & Render Messages
        async function loadMessages() {
            const { data: messages } = await supabase.from('messages').select('*').eq('to_id', userId).order('timestamp', { ascending: false });
            const list = document.getElementById('messagesList');
            list.innerHTML = messages?.map(msg => `
                <div class="border-bottom pb-2 mb-2">
                    <small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small><br>
                    <strong>Manager:</strong> ${msg.content}
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="replyToMessage('${msg.id}')">Reply</button>
                </div>
            `).join('') || '<p>No messages yet.</p>';
        }

        // Reply to Message (Prompt for simplicity)
        window.replyToMessage = async (msgId) => {
            const reply = prompt('Your reply:');
            if (!reply) return;
            const { error } = await supabase.from('messages').insert({
                content: reply,
                from_id: userId,
                to_id: null  // Broadcast? Or manager UUID—enhance later
            });
            if (error) alert(error.message);
            else loadMessages();
        };

        // Alert Helper
        function showAlert(msg, type = 'info') {
            const alert = document.getElementById('saleAlert');
            alert.textContent = msg;
            alert.className = `alert alert-${type}`;
            alert.classList.remove('d-none');
            setTimeout(() => alert.classList.add('d-none'), 5000);
        }

        // Real-Time Listeners
        supabase.channel('agent-updates').on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'agents', filter: `id=eq.${userId}` }, loadAgent).subscribe();
        supabase.channel('messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages', filter: `to_id=eq.${userId}).subscribe();
        loadAgent(); loadMessages();
        </script>)
